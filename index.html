<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dogpelgänger</title>
  <style>
    :root{
      --blue:#1e66ff;
      --blueHover:#1656d6;
      --bg:#ffffff;
      --text:#111111;
      --muted:#666666;
      --card:#ffffff;
      --border:#e6e6e6;
      --shadow:0 8px 24px rgba(0,0,0,0.08);
      --radius:14px;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: Georgia, "Times New Roman", Times, serif;
      color:var(--text);
      background:var(--bg);
    }

    .container{
      max-width: 1024px;
      margin: 0 auto;
      padding: 14px;
    }

    /* HERO */
    .heroWrap{
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      background: #fff;
    }
    .heroImg{
      width:100%;
      height:auto;
      display:block;
    }

    /* Button positioned over the "white" area (tuned for typical hero framing) */
    .heroCTA{
      position:absolute;
      left: 10%;
      top: 62%;
      transform: translateY(-50%);
      display:flex;
      flex-direction: column;
      gap: 10px;
      width: min(360px, 80%);
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      background: var(--blue);
      color: #fff;
      font-size: 18px;
      padding: 14px 16px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 8px 18px rgba(30,102,255,0.25);
      transition: transform .05s ease, background .15s ease;
      text-align:center;
    }
    .btn:hover{ background: var(--blueHover); }
    .btn:active{ transform: translateY(1px); }

    .hint{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
      background: rgba(255,255,255,0.78);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.08);
    }

    input[type="file"]{ display:none; }

    /* RESULTS */
    .resultsCard{
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .resultsHeader{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .resultsHeader h2{
      margin:0;
      font-size: 18px;
    }
    .status{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      min-height: 1.2em;
    }

    .results{
      display:flex;
      gap: 12px;
      align-items: flex-start;
    }
    .panel{
      flex:1;
      min-width: 0;
    }

    .panelTitle{
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 8px 0;
    }

    .imgBox{
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #fafafa;
      width: 100%;
    }
    .imgBox img{
      width:100%;
      height:auto;
      display:block;
    }

    .meta{
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      word-break: break-word;
    }

    /* Mobile: stack vertically */
    @media (max-width: 720px){
      .container{ padding: 10px; }
      .heroCTA{
        left: 50%;
        top: 68%;
        transform: translate(-50%, -50%);
        width: min(360px, 92%);
      }
      .btn{ font-size: 17px; }
      .results{ flex-direction: column; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="heroWrap">
      <img class="heroImg" src="hero.jpg" alt="Dogpelgänger hero image" />

      <div class="heroCTA">
        <button id="pickBtn" class="btn" type="button">Find Your Dogpelgänger</button>
        <div class="hint">
          Upload a portrait photo. We’ll find your closest dog match from the library.
        </div>
        <input id="fileInput" type="file" accept="image/*" />
      </div>
    </div>

    <div class="resultsCard">
      <div class="resultsHeader">
        <h2>Your match</h2>
        <p id="status" class="status"></p>
      </div>

      <div class="results" id="resultsRow" style="display:none;">
        <div class="panel">
          <p class="panelTitle">You</p>
          <div class="imgBox"><img id="humanImg" alt="Uploaded human" /></div>
          <div class="meta" id="humanMeta"></div>
        </div>

        <div class="panel">
          <p class="panelTitle">Your Dogpelgänger</p>
          <div class="imgBox"><img id="dogImg" alt="Matched dog" /></div>
          <div class="meta" id="dogMeta"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ✅ CHANGE THIS if your backend URL changes:
    const BACKEND_BASE = "https://dogpelganger.onrender.com";

    const pickBtn   = document.getElementById("pickBtn");
    const fileInput = document.getElementById("fileInput");
    const statusEl  = document.getElementById("status");
    const resultsRow= document.getElementById("resultsRow");

    const humanImg  = document.getElementById("humanImg");
    const dogImg    = document.getElementById("dogImg");
    const humanMeta = document.getElementById("humanMeta");
    const dogMeta   = document.getElementById("dogMeta");

    function setStatus(msg){ statusEl.textContent = msg || ""; }

    pickBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      // Show uploaded image immediately
      const blobUrl = URL.createObjectURL(file);
      humanImg.src = blobUrl;
      humanMeta.textContent = file.name;
      dogImg.removeAttribute("src");
      dogMeta.textContent = "";

      resultsRow.style.display = "flex";
      setStatus("Analyzing…");

      try {
        // 1) Embed in browser (MobileNet feature vector) — must match backend dim (1280)
        const embedding = await embedImageMobileNet(file);

        // 2) Ask backend for exactly ONE match
        const resp = await fetch(`${BACKEND_BASE}/match`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ embedding, top_k: 1 })
        });

        if (!resp.ok) {
          const t = await resp.text();
          throw new Error(`Backend error: ${t}`);
        }

        const data = await resp.json();
        const match = data.top_matches?.[0];
        if (!match) throw new Error("No match returned.");

        dogImg.src = match.dog_url;
        dogMeta.textContent = `${match.dog_image}  •  score ${(match.score ?? 0).toFixed(3)}`;

        setStatus("");
      } catch (err) {
        console.error(err);
        setStatus(String(err?.message || err));
      }
    });

    // --- Browser embedding (MobileNet via TensorFlow.js) ---
    // If you already had a working embedder in your previous HTML, keep this function signature
    // and paste that implementation here. Below is a robust TFJS MobileNet embedder.

    async function embedImageMobileNet(file) {
      // Lazy-load TFJS + MobileNet only when needed
      await loadScriptOnce("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js");
      await loadScriptOnce("https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js");

      // Ensure tf global exists
      if (!window.tf) throw new Error("TensorFlow.js failed to load.");
      if (!window.mobilenet) throw new Error("MobileNet model failed to load.");

      // Load model once
      if (!window.__dp_mobilenet_model) {
        setStatus("Loading model… (first time only)");
        window.__dp_mobilenet_model = await window.mobilenet.load({ version: 2, alpha: 1.0 });
      }
      const model = window.__dp_mobilenet_model;

      const imgEl = await fileToImageElement(file);

      // Mobilenet expects an HTMLImageElement; use infer(img, 'conv_preds') -> 1000 class logits
      // But we need the 1280-d pooled embedding. TFJS MobileNet supports infer(img, true) for embedding.
      const embTensor = model.infer(imgEl, true);  // => [1, 1024] or [1, 1280] depending on version/alpha
      const emb = await embTensor.data();
      embTensor.dispose();

      // Convert TypedArray -> normal array
      const arr = Array.from(emb);

      // Sanity check: backend expects 1280
      if (arr.length !== 1280) {
        throw new Error(`Backend error: Embedding dim ${arr.length} != expected 1280`);
      }

      return arr;
    }

    function loadScriptOnce(src) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[data-src="${src}"]`);
        if (existing) return resolve();

        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.setAttribute("data-src", src);
        s.onload = () => resolve();
        s.onerror = () => reject(new Error(`Failed to load script: ${src}`));
        document.head.appendChild(s);
      });
    }

    function fileToImageElement(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => {
          URL.revokeObjectURL(url);
          resolve(img);
        };
        img.onerror = () => reject(new Error("Could not read image."));
        img.src = url;
      });
    }
  </script>
</body>
</html>
